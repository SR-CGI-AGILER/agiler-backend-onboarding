---
  version: 2.0
  jobs:
    build:
      docker:
        - image: circleci/node:8
      steps:
        - checkout
        - setup_remote_docker
        - run :
            name: Make the environment as dev
            command: |
              EXPORT NODE_ENV=dev
        - run :
            name: Make the executable
            command: |
              ====================DOUBT!!!========================= 
        - run :
            name: Setup common environment variables
          command: |
            echo 'export ECR_REPOSITORY_NAME="${AWS_RESOURCE_NAME_PREFIX}"' >> $BASH_ENV
            echo 'export FULL_IMAGE_NAME="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com/${ECR_REPOSITORY_NAME}:${CIRCLE_SHA1}"' >> $BASH_ENV 
        - run:
          name: Build image
          command: |
            docker build -t $FULL_IMAGE_NAME .
        - run:
            name: Test image
            command: |
              docker run -d -p 8080:8080 --name built-image $FULL_IMAGE_NAME
              sleep 10
              docker run --network container:built-image appropriate/curl --retry 10 --retry-connrefused http://localhost:8080 | grep "Hello World!"
        - run:
            name: Save image to an archive
            command: |
              mkdir docker-image
              docker save -o docker-image/image.tar $FULL_IMAGE_NAME
    deploy:
      docker:
        - image: circleci/node:8
      steps:
        - run EXPORT NODE  